<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Indian Classical Music Trainer</title>
<style>
  :root {
    --primary: #4E342E; /* Darker Brown */
    --secondary: #795548; /* Brown */
    --accent: #FFC107; /* Amber */
    --bg: #FFF8E1; /* Beige */
    --panel-bg: #FFFFFF;
    --text: #3E2723;
    --highlight: #FF5722; /* Deep Orange */
  }

  * { box-sizing: border-box; }

  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background-color: var(--bg);
    color: var(--text);
    margin: 0;
    height: 100vh;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  .app-container {
    display: flex; flex: 1; height: 100%; position: relative;
  }

  /* --- WELCOME MODAL --- */
  .modal-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.6);
    z-index: 1000;
    display: flex; justify-content: center; align-items: center;
    backdrop-filter: blur(4px);
  }
  .modal-box {
    background: white; padding: 30px; border-radius: 15px;
    text-align: center; max-width: 90%; width: 350px;
    box-shadow: 0 10px 25px rgba(0,0,0,0.3);
    animation: popIn 0.3s ease-out;
  }
  @keyframes popIn { from {transform: scale(0.8); opacity:0;} to {transform: scale(1); opacity:1;} }
  
  .start-btn {
    background: var(--highlight); color: white; padding: 12px 30px;
    border: none; border-radius: 50px; font-size: 1.1rem; font-weight: bold;
    cursor: pointer; margin-top: 20px;
    box-shadow: 0 4px 10px rgba(255,87,34,0.3);
  }

  /* --- HEADER (Mobile) --- */
  header {
    background-color: var(--primary);
    color: white; padding: 15px;
    display: flex; justify-content: space-between; align-items: center;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    z-index: 100;
  }
  .menu-toggle { background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer; }

  /* --- SIDEBAR --- */
  .sidebar {
    width: 300px;
    background: var(--panel-bg);
    border-right: 1px solid #ccc;
    display: flex; flex-direction: column;
    z-index: 200;
    transition: transform 0.3s ease;
    position: absolute; top: 0; bottom: 0; left: 0;
    transform: translateX(-100%);
  }

  @media (min-width: 769px) {
    header { display: none; }
    .sidebar { position: relative; transform: translateX(0); box-shadow: 2px 0 5px rgba(0,0,0,0.1); }
  }

  .sidebar.open { transform: translateX(0); box-shadow: 2px 0 15px rgba(0,0,0,0.5); }

  .sidebar-header {
    padding: 20px; background: var(--primary); color: white;
    font-size: 1.2rem; display: flex; justify-content: space-between; align-items: center;
  }

  /* Extra Menu Buttons */
  .extra-menu {
    display: flex; border-bottom: 1px solid #eee; background: #fafafa;
  }
  .extra-btn {
    flex: 1; padding: 15px; border: none; background: transparent;
    cursor: pointer; color: var(--secondary); font-weight: bold; font-size: 0.9rem;
    display: flex; flex-direction: column; align-items: center; gap: 5px;
  }
  .extra-btn:hover { background: #eee; color: var(--primary); }

  .lesson-list { flex: 1; overflow-y: auto; }
  .cat-item { border-bottom: 1px solid #eee; }
  .cat-header { padding: 15px 20px; cursor: pointer; font-weight: 600; display: flex; justify-content: space-between; color: var(--primary); }
  .cat-header:hover { background-color: #f9f9f9; }
  .sub-lessons { display: none; background: #f5f5f5; }
  .sub-lesson { padding: 10px 30px; cursor: pointer; font-size: 0.95rem; color: #555; border-bottom: 1px solid #e0e0e0; }
  .sub-lesson:hover { background: #eee; }

  /* PRO BUTTON */
  .pro-section { padding: 15px; border-top: 1px solid #ddd; background: #fafafa; }
  .pro-btn {
    width: 100%; padding: 12px; border: none; border-radius: 8px;
    background: var(--text); color: white; font-weight: bold; cursor: pointer;
    transition: all 0.3s;
  }
  .pro-btn.active-mode {
    background: var(--highlight);
    box-shadow: 0 0 10px rgba(255,87,34,0.4);
    animation: pulse 2s infinite;
  }
  @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.02); } 100% { transform: scale(1); } }

  /* --- MAIN --- */
  .main-content {
    flex: 1; display: flex; flex-direction: column;
    padding: 20px; align-items: center; overflow-y: auto;
    position: relative;
  }

  .display-area { margin-top: 20px; width: 100%; max-width: 800px; min-height: 200px; text-align: center; }
  
  .notes-container {
    display: flex; flex-wrap: wrap; justify-content: center; gap: 8px; margin: 30px 0;
  }

  .note-card {
    min-width: 45px; height: 45px; padding: 0 10px;
    display: flex; align-items: center; justify-content: center;
    background: white; border: 1px solid #d7ccc8; border-radius: 6px;
    font-weight: bold; font-size: 1.1rem;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05); text-transform: uppercase;
  }

  .note-card.active {
    background: var(--highlight); color: white;
    transform: scale(1.15); border-color: var(--highlight);
    box-shadow: 0 4px 12px rgba(255,87,34,0.4);
    transition: transform 0.1s ease-out;
  }

  .controls-box {
    background: white; padding: 20px; border-radius: 12px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.08); width: 100%; max-width: 400px;
  }
  .ctrl-row { margin-bottom: 15px; }
  .ctrl-row label { display: block; font-size: 0.85rem; margin-bottom: 5px; color: #666; }
  select, input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 1rem; }
  .btn-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; }
  .action-btn { padding: 12px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; color: white; }
  .play-btn { background: var(--primary); }
  .stop-btn { background: #d32f2f; }
  .play-btn:disabled { background: #ccc; cursor: not-allowed; }
  .info-banner { background: #E3F2FD; color: #0D47A1; padding: 10px; width: 100%; text-align: center; border-radius: 6px; margin-bottom: 15px; display: none; }

  /* --- FOOTER --- */
  .ramu-footer {
    margin-top: auto; /* Pushes to bottom */
    padding: 20px;
    color: #888;
    font-size: 0.9rem;
    text-align: center;
    font-weight: 500;
  }

</style>
</head>
<body>

<div class="modal-overlay" id="welcomeModal">
  <div class="modal-box">
    <div style="font-size: 3rem; margin-bottom: 10px;">ðŸŽµ</div>
    <h2 style="color:var(--primary); margin:0;">Namaste!</h2>
    <p style="color:#666; line-height:1.5;">Welcome to your personal Classical Music Trainer. Ready to master the Swaras?</p>
    <button class="start-btn" onclick="closeModal()">Let's Start</button>
  </div>
</div>

<header>
  <div style="font-weight:bold;">ðŸŽµ Classical Trainer</div>
  <button class="menu-toggle" onclick="toggleSidebar()">â˜°</button>
</header>

<div class="app-container">
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <span>Menu</span>
      <span onclick="toggleSidebar()" style="cursor:pointer; font-size:1.5rem;" class="mobile-close">&times;</span>
    </div>
    
    <div class="extra-menu">
      <button class="extra-btn" onclick="alert('Progress Tracking coming soon!')">
        <span>ðŸ“Š</span> Progress
      </button>
      <button class="extra-btn" onclick="alert('Practice History coming soon!')">
        <span>ðŸ“œ</span> History
      </button>
    </div>

    <div class="lesson-list" id="lessonListContainer"></div>
    
    <div class="pro-section">
      <button class="pro-btn" id="btnProMode" onclick="toggleProMode()">â˜… Learn Like a Pro</button>
      <div id="proHelpText" style="font-size:0.75rem; color:#666; margin-top:5px; text-align:center; display:none;">Select a Category to auto-play all.</div>
    </div>
  </aside>

  <main class="main-content">
    <div class="info-banner" id="statusBanner"></div>
    <h2 id="currentLessonTitle" style="color:var(--primary);">Select a Lesson</h2>
    <h4 id="currentLessonSubtitle" style="color:var(--secondary); font-weight:normal; margin-top:-10px;"></h4>
    
    <div class="display-area">
      <div class="notes-container" id="notesDisplay"></div>
    </div>

    <div class="controls-box">
      <div class="ctrl-row">
        <label>Instrument</label>
        <select id="instrumentSelect">
          <option value="sine">Sine Wave</option>
          <option value="flute">Flute</option>
          <option value="keyboard">Keyboard</option>
          <option value="violin">Violin (Improved)</option>
        </select>
      </div>

      <div class="ctrl-row" id="normalControls">
        <label>Speed (BPM)</label>
        <input type="number" id="bpmInput" value="120" step="10" min="40" max="400">
      </div>

      <div class="ctrl-row" id="proControls" style="display:none; background: #FFF3E0; padding:10px; border-radius:6px;">
        <label style="color:var(--highlight); font-weight:bold;">Pro Mode Pattern</label>
        <input type="text" id="proPatternInput" value="60, 120, 240">
        <div style="font-size:0.75rem; color:#666; margin-top:5px;">60=1x, 120=2x, 240=4x</div>
      </div>

      <div class="btn-grid">
        <button class="action-btn play-btn" id="btnPlay" onclick="togglePlay()">Play</button>
        <button class="action-btn stop-btn" onclick="stopPlayback()">Stop</button>
      </div>
    </div>

    <div class="ramu-footer">
      made with ðŸ’– by ramu
    </div>
  </main>
</div>

<script>
/*******************************************************
 * 1. UI HELPERS
 *******************************************************/
function closeModal() {
  const modal = document.getElementById('welcomeModal');
  modal.style.opacity = '0';
  setTimeout(() => modal.style.display = 'none', 300);
  
  // Resume Audio Context on user interaction (browser policy)
  if(audioCtx.state === 'suspended') audioCtx.resume();
}

/*******************************************************
 * 2. DATA
 *******************************************************/
const LESSON_DATA = {
  'Sarali Varusai': [
    ['s','r','g','m','p','d','n','sa','sa','n','d','p','m','g','r','s'],
    ['s','r','s','r','s','r','g','m','s','r','g','m','p','d','n','sa','sa','n','sa','n','sa','n','d','p','sa','n','d','p','m','g','r','s'],
    ['s','r','g','s','r','g','s','r','s','r','g','m','p','d','n','sa','sa','n','d','sa','n','d','sa','n','sa','n','d','p','m','g','r','s'],
    ['s','r','g','m','s','r','g','m','s','r','g','m','p','d','n','sa','sa','n','d','p','sa','n','d','p','sa','n','d','p','m','g','r','s'],
    ['s','r','g','m','p_2','s','r','s','r','g','m','p','d','n','sa','sa','n','d','p','m_2','sa','n','sa','n','d','p','m','g','r','s'],
    ['s','r','g','m','p','d','s','r','s','r','g','m','p','d','n','sa','sa','n','d','p','m','g','sa','n','sa','n','d','p','m','g','r','s'],
    ['s','r','g','m','p','d','n_2','s','r','g','m','p','d','n','sa','sa','n','d','p','m','g','r_2','sa','n','d','p','m','g','r','s']
  ],
  'Long Note Test': [
    ['s_2', 'r_2', 'g_2', 'm_2'], 
    ['s', 's', 'r_3', 'g', 'm']    
  ],
  'Jandai Varusai': [
    ['s','s','r','r','g','g','m','m','p','p','d','d','n','n','sa','sa','sa','sa','n','n','d','d','p','p','m','m','g','g','r','r','s','s'],
    ['s','s','r_2','s','s','r_2','s','r','s','s','r','r','g','g','m','m','r','r','g_2','r','r','g_2','r','g','r','r','g','g','m','m','p','p'],
    ['s','r','g','m','p','d','n','sa','s','r','g','m','p','d','n','sa']
  ],
  'Sarali Malai': [
    ['s','r','s','r','s','r','g','m','s','r','g','s','r','g','s','r','s','r','g','m','s','r','g','m','s','r','g','m','p_2','s','r','s','r','g','m','p','d','s','r','s','r','g','m','p','d','n_2','s','r','g','m','p','m','g','r','s']
  ],
  'new Varusai': [
    ['s','n']
  ]
};

const FREQ_MAP = {
  's': 261.63, 'r': 293.66, 'g': 329.63, 'm': 349.23,
  'p': 392.00, 'd': 440.00, 'n': 493.88, 'sa': 523.25
};

let audioCtx = new (window.AudioContext || window.webkitAudioContext)();
let state = {
  isPro: false, isPlaying: false, noteIndex: 0, timer: null,
  currentNotes: [], currentBpm: 120, queue: []
};

// UI Refs
const els = {
  list: document.getElementById('lessonListContainer'),
  notes: document.getElementById('notesDisplay'),
  playBtn: document.getElementById('btnPlay'),
  title: document.getElementById('currentLessonTitle'),
  subTitle: document.getElementById('currentLessonSubtitle'),
  sidebar: document.getElementById('sidebar'),
  status: document.getElementById('statusBanner'),
  proBtn: document.getElementById('btnProMode'),
  proHelp: document.getElementById('proHelpText'),
  normalCtrl: document.getElementById('normalControls'),
  proCtrl: document.getElementById('proControls')
};

// Init
renderSidebar();

// --- LOGIC ---
function renderSidebar() {
  els.list.innerHTML = '';
  Object.keys(LESSON_DATA).forEach(category => {
    const lessons = LESSON_DATA[category];
    const wrapper = document.createElement('div');
    wrapper.className = 'cat-item';
    
    const header = document.createElement('div');
    header.className = 'cat-header';
    header.innerHTML = `<span>${category}</span> <small>(${lessons.length})</small>`;
    
    const subContainer = document.createElement('div');
    subContainer.className = 'sub-lessons';
    
    header.onclick = () => {
      if(state.isPro) {
        queueCategory(category);
        if(window.innerWidth < 768) toggleSidebar();
      } else {
        const isVis = subContainer.style.display === 'block';
        document.querySelectorAll('.sub-lessons').forEach(el => el.style.display = 'none');
        subContainer.style.display = isVis ? 'none' : 'block';
      }
    };

    lessons.forEach((notes, i) => {
      const item = document.createElement('div');
      item.className = 'sub-lesson';
      item.innerText = `Lesson ${i + 1}`;
      item.onclick = (e) => {
        if(state.isPro) return;
        e.stopPropagation();
        loadLesson(category, i);
        if(window.innerWidth < 768) toggleSidebar();
      };
      subContainer.appendChild(item);
    });

    wrapper.appendChild(header);
    wrapper.appendChild(subContainer);
    els.list.appendChild(wrapper);
  });
}

function toggleSidebar() { els.sidebar.classList.toggle('open'); }

function toggleProMode() {
  stopPlayback();
  state.isPro = !state.isPro;
  if (state.isPro) {
    els.proBtn.classList.add('active-mode');
    els.proBtn.innerHTML = "âœ“ Pro Mode Active";
    els.proHelp.style.display = 'block';
    els.normalCtrl.style.display = 'none';
    els.proCtrl.style.display = 'block';
    els.status.innerText = "PRO MODE: Select a Category on the left to start.";
    els.status.style.display = 'block';
    els.playBtn.disabled = true;
    document.querySelectorAll('.sub-lessons').forEach(el => el.style.display = 'none');
  } else {
    els.proBtn.classList.remove('active-mode');
    els.proBtn.innerHTML = "â˜… Learn Like a Pro";
    els.proHelp.style.display = 'none';
    els.normalCtrl.style.display = 'block';
    els.proCtrl.style.display = 'none';
    els.status.style.display = 'none';
    els.playBtn.disabled = false;
  }
}

function loadLesson(cat, index) {
  stopPlayback();
  const notes = LESSON_DATA[cat][index];
  state.currentNotes = notes;
  els.title.innerText = `${cat} - Lesson ${index+1}`;
  els.subTitle.innerText = "Standard Mode";
  renderNotes(notes);
}

function queueCategory(cat) {
  stopPlayback();
  state.queue = [];
  const input = document.getElementById('proPatternInput').value;
  let bpms = input.split(',').map(n => parseInt(n.trim())).filter(n => !isNaN(n));
  if(bpms.length === 0) bpms = [60, 120, 240];

  const lessons = LESSON_DATA[cat];
  lessons.forEach((notes, lIndex) => {
    bpms.forEach(bpm => {
      let reps = Math.round(bpm / 60);
      if(reps < 1) reps = 1;
      for(let r=1; r<=reps; r++) {
        state.queue.push({
          notes: notes, bpm: bpm,
          title: `${cat} - Lesson ${lIndex+1}`,
          subTitle: `Pro Mode: ${bpm} BPM (Repetition ${r} of ${reps})`
        });
      }
    });
  });
  playNextInQueue();
}

function playNextInQueue() {
  if(state.queue.length === 0) {
    els.status.innerText = "Pro Sequence Finished!";
    els.playBtn.innerText = "Play";
    els.playBtn.disabled = true;
    return;
  }
  const task = state.queue.shift();
  state.currentNotes = task.notes;
  state.currentBpm = task.bpm;
  state.noteIndex = 0;
  els.title.innerText = task.title;
  els.subTitle.innerText = task.subTitle;
  renderNotes(task.notes);
  state.isPlaying = true;
  els.playBtn.innerText = "Pause";
  els.playBtn.disabled = false;
  playLoop();
}

function renderNotes(notes) {
  els.notes.innerHTML = '';
  notes.forEach((n, i) => {
    const d = document.createElement('div');
    d.className = 'note-card';
    d.id = 'n'+i;
    d.innerText = n.split('_')[0]; 
    els.notes.appendChild(d);
  });
}

function togglePlay() {
  if(state.isPlaying) {
    state.isPlaying = false; clearTimeout(state.timer);
    els.playBtn.innerText = "Resume";
  } else {
    if(!state.currentNotes.length) return alert("Please select a lesson first.");
    state.isPlaying = true; els.playBtn.innerText = "Pause";
    if(audioCtx.state === 'suspended') audioCtx.resume();
    playLoop();
  }
}

function stopPlayback() {
  state.isPlaying = false; state.noteIndex = 0; state.queue = [];
  clearTimeout(state.timer); els.playBtn.innerText = "Play";
  document.querySelectorAll('.note-card.active').forEach(el => el.classList.remove('active'));
  if(state.isPro) {
     els.status.innerText = "Pro Mode Stopped (Select Category to restart)";
     els.playBtn.disabled = true;
  }
}

// --- CORE PLAYBACK LOOP ---
function playLoop() {
  if(!state.isPlaying) return;

  if(state.noteIndex >= state.currentNotes.length) {
    if(state.isPro) { setTimeout(playNextInQueue, 500); }
    else { state.noteIndex = 0; playLoop(); }
    return;
  }

  document.querySelectorAll('.note-card').forEach(e => e.classList.remove('active'));
  const currentEl = document.getElementById('n'+state.noteIndex);
  if(currentEl) currentEl.classList.add('active');

  const noteStr = state.currentNotes[state.noteIndex];
  const parts = noteStr.split('_');
  const noteName = parts[0];
  const multiplier = parts.length > 1 ? parseFloat(parts[1]) : 1;

  const bpm = state.isPro ? state.currentBpm : parseInt(document.getElementById('bpmInput').value);
  const baseDuration = 60 / bpm; 
  const totalDuration = baseDuration * multiplier;

  playTone(noteName, totalDuration);

  state.noteIndex++;
  state.timer = setTimeout(playLoop, totalDuration * 1000);
}

// --- AUDIO ENGINE ---
function playTone(note, duration) {
  const osc = audioCtx.createOscillator();
  const gain = audioCtx.createGain();
  
  const base = note.split('_')[0];
  osc.frequency.value = FREQ_MAP[base] || 261.63;
  
  const inst = document.getElementById('instrumentSelect').value;
  let isViolin = false;

  switch(inst) {
    case 'flute': osc.type = 'triangle'; break;
    case 'keyboard': osc.type = 'square'; break;
    case 'violin': 
      osc.type = 'sawtooth'; 
      isViolin = true; 
      break;
    default: osc.type = 'sine';
  }

  if (isViolin) {
    const filter = audioCtx.createBiquadFilter();
    filter.type = 'lowpass';
    filter.frequency.value = 2000; 
    osc.connect(filter);
    filter.connect(gain);
    
    // Vibrato
    const vibOsc = audioCtx.createOscillator();
    const vibGain = audioCtx.createGain();
    vibOsc.frequency.value = 6; 
    vibGain.gain.value = 4; 
    vibOsc.connect(vibGain);
    vibGain.connect(osc.frequency);
    vibOsc.start(audioCtx.currentTime);
    vibOsc.stop(audioCtx.currentTime + duration);
  } else {
    osc.connect(gain); 
  }
  
  gain.connect(audioCtx.destination);
  
  const now = audioCtx.currentTime;
  const gap = 0.05; 
  const playTime = duration - gap; 
  const stopTime = now + duration;

  gain.gain.setValueAtTime(0, now);
  
  if (isViolin) {
    gain.gain.linearRampToValueAtTime(0.4, now + 0.15); 
    gain.gain.setValueAtTime(0.4, stopTime - 0.1);
    gain.gain.linearRampToValueAtTime(0.001, stopTime);
  } else {
    gain.gain.linearRampToValueAtTime(0.4, now + 0.05);
    gain.gain.setValueAtTime(0.4, now + playTime);
    gain.gain.linearRampToValueAtTime(0.001, stopTime);
  }
  
  osc.start(now);
  osc.stop(stopTime);
}

</script>


</body>
</html>
